<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Limpiando cache...</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 100vh;
				margin: 0;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			}
			.container {
				text-align: center;
				padding: 2rem;
				max-width: 500px;
			}
			.spinner {
				border: 4px solid rgba(255, 255, 255, 0.3);
				border-radius: 50%;
				border-top: 4px solid white;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
				margin: 2rem auto;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.progress {
				margin-top: 1rem;
				font-size: 0.9rem;
				opacity: 0.9;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ðŸ§¹ Limpiando datos antiguos...</h1>
			<div class="spinner"></div>
			<p class="progress" id="status">Iniciando limpieza...</p>
		</div>

		<script>
			(function () {
				var status = document.getElementById("status");
				var returnUrl = sessionStorage.getItem("return_url") || "/";

				function updateStatus(message) {
					status.textContent = message;
					console.log("Cleanup:", message);
				}

				function cleanup() {
					var cleanupDone = sessionStorage.getItem("cleanup_done_v3");

					if (cleanupDone) {
						updateStatus("Limpieza ya realizada, redirigiendo...");
						setTimeout(function () {
							window.location.href = returnUrl;
						}, 500);
						return;
					}

					if (!("serviceWorker" in navigator)) {
						updateStatus("Service Workers no soportados, redirigiendo...");
						sessionStorage.setItem("cleanup_done_v3", "true");
						setTimeout(function () {
							window.location.href = returnUrl;
						}, 500);
						return;
					}

					updateStatus("Buscando Service Workers antiguos...");

					navigator.serviceWorker
						.getRegistrations()
						.then(function (registrations) {
							updateStatus("Encontrados " + registrations.length + " Service Worker(s)");

							if (registrations.length === 0) {
								return Promise.resolve();
							}

							return Promise.all(
								registrations.map(function (registration) {
									updateStatus("Des-registrando SW: " + registration.scope);
									return registration.unregister();
								}),
							);
						})
						.then(function () {
							updateStatus("Service Workers eliminados");

							if ("caches" in window) {
								return caches.keys();
							}
							return [];
						})
						.then(function (cacheNames) {
							if (cacheNames.length === 0) {
								updateStatus("No hay caches que eliminar");
								return Promise.resolve();
							}

							updateStatus("Eliminando " + cacheNames.length + " cache(s)...");

							return Promise.all(
								cacheNames.map(function (cacheName) {
									return caches.delete(cacheName);
								}),
							);
						})
						.then(function () {
							updateStatus("âœ“ Limpieza completada!");
							sessionStorage.setItem("cleanup_done_v3", "true");

							setTimeout(function () {
								updateStatus("Redirigiendo...");
								window.location.href = returnUrl;
							}, 1000);
						})
						.catch(function (error) {
							console.error("Error durante limpieza:", error);
							updateStatus("Error: " + error.message);

							// Intentar redireccionar de todos modos
							setTimeout(function () {
								sessionStorage.setItem("cleanup_done_v3", "true");
								window.location.href = returnUrl;
							}, 2000);
						});
				}

				// Ejecutar limpieza al cargar
				cleanup();
			})();
		</script>
	</body>
</html>
