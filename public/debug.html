<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Debug - Law Analytics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            background: #f9f9f9;
            border-left: 3px solid #007bff;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Panel - Law Analytics</h1>
    
    <div class="card">
        <h2>üìä Estado del Sistema</h2>
        <div id="system-info"></div>
    </div>

    <div class="card">
        <h2>üîß Service Workers</h2>
        <div id="sw-info"></div>
        <button onclick="clearServiceWorkers()">Limpiar Service Workers</button>
        <button onclick="checkSW()">Verificar SW</button>
    </div>

    <div class="card">
        <h2>üíæ Cach√©s</h2>
        <div id="cache-info"></div>
        <button onclick="clearAllCaches()">Limpiar Todos los Cach√©s</button>
        <button onclick="checkCaches()">Verificar Cach√©s</button>
    </div>

    <div class="card">
        <h2>üåê Verificaci√≥n de Red</h2>
        <div id="network-info"></div>
        <button onclick="testNetwork()">Test de Red</button>
    </div>

    <div class="card">
        <h2>üìù Logs en Tiempo Real</h2>
        <div id="logs" style="max-height: 300px; overflow-y: auto;"></div>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="status ${type}">${new Date().toLocaleTimeString()}</span> ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        };

        const clearLogs = () => {
            document.getElementById('logs').innerHTML = '';
            log('Logs limpiados', 'info');
        };

        // Informaci√≥n del sistema
        const showSystemInfo = () => {
            const info = {
                'User Agent': navigator.userAgent,
                'Plataforma': navigator.platform,
                'Idioma': navigator.language,
                'Online': navigator.onLine ? 'S√≠' : 'No',
                'Cookies Habilitadas': navigator.cookieEnabled ? 'S√≠' : 'No',
                'Service Worker Soportado': 'serviceWorker' in navigator ? 'S√≠' : 'No',
                'Cache API Soportado': 'caches' in window ? 'S√≠' : 'No',
                'URL Actual': window.location.href,
                'Protocolo': window.location.protocol,
                'Host': window.location.host
            };

            let html = '<table style="width:100%">';
            for (let [key, value] of Object.entries(info)) {
                html += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('system-info').innerHTML = html;
            log('Informaci√≥n del sistema cargada', 'success');
        };

        // Service Workers
        const checkSW = async () => {
            const swDiv = document.getElementById('sw-info');
            
            if (!('serviceWorker' in navigator)) {
                swDiv.innerHTML = '<span class="status error">Service Workers no soportados</span>';
                log('Service Workers no soportados en este navegador', 'error');
                return;
            }

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                if (registrations.length === 0) {
                    swDiv.innerHTML = '<span class="status success">No hay Service Workers registrados</span>';
                    log('No se encontraron Service Workers', 'success');
                } else {
                    let html = '<h4>Service Workers Encontrados:</h4><ul>';
                    registrations.forEach(reg => {
                        const state = reg.active ? 'Activo' : reg.waiting ? 'Esperando' : reg.installing ? 'Instalando' : 'Desconocido';
                        html += `<li>Scope: ${reg.scope}<br>Estado: ${state}<br>`;
                        if (reg.active) {
                            html += `Script: ${reg.active.scriptURL}</li>`;
                        }
                        log(`SW encontrado: ${reg.scope} - ${state}`, 'warning');
                    });
                    html += '</ul>';
                    swDiv.innerHTML = html;
                }
            } catch (error) {
                swDiv.innerHTML = `<span class="status error">Error: ${error.message}</span>`;
                log(`Error verificando SW: ${error.message}`, 'error');
            }
        };

        const clearServiceWorkers = async () => {
            log('Iniciando limpieza de Service Workers...', 'info');
            
            if (!('serviceWorker' in navigator)) {
                log('Service Workers no soportados', 'error');
                return;
            }

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                for (let registration of registrations) {
                    await registration.unregister();
                    log(`SW desregistrado: ${registration.scope}`, 'success');
                }
                
                log(`${registrations.length} Service Workers eliminados`, 'success');
                setTimeout(checkSW, 1000);
            } catch (error) {
                log(`Error limpiando SW: ${error.message}`, 'error');
            }
        };

        // Cach√©s
        const checkCaches = async () => {
            const cacheDiv = document.getElementById('cache-info');
            
            if (!('caches' in window)) {
                cacheDiv.innerHTML = '<span class="status error">Cache API no soportado</span>';
                log('Cache API no soportado', 'error');
                return;
            }

            try {
                const cacheNames = await caches.keys();
                
                if (cacheNames.length === 0) {
                    cacheDiv.innerHTML = '<span class="status success">No hay cach√©s almacenados</span>';
                    log('No se encontraron cach√©s', 'success');
                } else {
                    let html = '<h4>Cach√©s Encontrados:</h4><ul>';
                    for (let name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        html += `<li><strong>${name}</strong>: ${keys.length} elementos</li>`;
                        log(`Cach√© encontrado: ${name} (${keys.length} elementos)`, 'info');
                    }
                    html += '</ul>';
                    cacheDiv.innerHTML = html;
                }
            } catch (error) {
                cacheDiv.innerHTML = `<span class="status error">Error: ${error.message}</span>`;
                log(`Error verificando cach√©s: ${error.message}`, 'error');
            }
        };

        const clearAllCaches = async () => {
            log('Iniciando limpieza de cach√©s...', 'info');
            
            if (!('caches' in window)) {
                log('Cache API no soportado', 'error');
                return;
            }

            try {
                const cacheNames = await caches.keys();
                
                for (let name of cacheNames) {
                    await caches.delete(name);
                    log(`Cach√© eliminado: ${name}`, 'success');
                }
                
                log(`${cacheNames.length} cach√©s eliminados`, 'success');
                setTimeout(checkCaches, 1000);
            } catch (error) {
                log(`Error limpiando cach√©s: ${error.message}`, 'error');
            }
        };

        // Test de Red
        const testNetwork = async () => {
            const networkDiv = document.getElementById('network-info');
            let html = '<h4>Pruebas de Red:</h4>';
            
            log('Iniciando pruebas de red...', 'info');

            // Test 1: Verificar index.html
            try {
                const response = await fetch('/', { cache: 'no-store' });
                html += `<p>‚úÖ index.html: ${response.status} ${response.statusText}</p>`;
                log(`index.html: ${response.status}`, 'success');
                
                // Verificar versi√≥n
                const text = await response.text();
                const versionMatch = text.match(/app-version.*content="([^"]+)"/);
                if (versionMatch) {
                    html += `<p>üìå Versi√≥n detectada: ${versionMatch[1]}</p>`;
                    log(`Versi√≥n: ${versionMatch[1]}`, 'info');
                }
            } catch (error) {
                html += `<p>‚ùå index.html: ${error.message}</p>`;
                log(`Error cargando index.html: ${error.message}`, 'error');
            }

            // Test 2: Verificar manifest.json
            try {
                const response = await fetch('/manifest.json', { cache: 'no-store' });
                html += `<p>‚úÖ manifest.json: ${response.status}</p>`;
                log(`manifest.json: ${response.status}`, 'success');
            } catch (error) {
                html += `<p>‚ùå manifest.json: ${error.message}</p>`;
                log(`Error cargando manifest.json: ${error.message}`, 'error');
            }

            // Test 3: Verificar un chunk aleatorio
            try {
                const response = await fetch('/');
                const text = await response.text();
                const chunkMatch = text.match(/src="(\/assets\/[^"]+\.js)"/);
                
                if (chunkMatch) {
                    const chunkUrl = chunkMatch[1];
                    const chunkResponse = await fetch(chunkUrl, { cache: 'no-store' });
                    html += `<p>‚úÖ Chunk JS: ${chunkResponse.status} (${chunkUrl})</p>`;
                    log(`Chunk cargado: ${chunkUrl}`, 'success');
                } else {
                    html += '<p>‚ö†Ô∏è No se encontraron chunks en index.html</p>';
                    log('No se encontraron chunks', 'warning');
                }
            } catch (error) {
                html += `<p>‚ùå Error verificando chunks: ${error.message}</p>`;
                log(`Error verificando chunks: ${error.message}`, 'error');
            }

            networkDiv.innerHTML = html;
        };

        // Inicializar al cargar
        window.addEventListener('load', () => {
            showSystemInfo();
            checkSW();
            checkCaches();
            testNetwork();
            
            // Interceptar errores globales
            window.addEventListener('error', (event) => {
                log(`Error global: ${event.message}`, 'error');
            });

            window.addEventListener('unhandledrejection', (event) => {
                log(`Promise rechazada: ${event.reason}`, 'error');
            });
        });

        // Auto-actualizar cada 5 segundos
        setInterval(() => {
            checkSW();
            checkCaches();
        }, 5000);
    </script>
</body>
</html>